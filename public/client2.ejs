<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="/socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
        <title>Socket Client</title>

        <script>
            let userId=2;
            let chatLog; // 모든 채팅로그를 보유하고 있는 변수
            
            const url = 'http://localhost:4500';
            window.onload=function(){
                const socket=io(url,{
                    path:'/socket.io',
                    query:{
                        userId:userId,
                        nickname:'aaaaaaaaa'
                    }
                });
                document.getElementById('chatSend').onclick=function(){
                    let roomId=$('#chatRoom').val();
                    let nickName=document.getElementById('chatNickName').value;
                    let msg=document.getElementById('chatMessage').value;

                    socket.emit('sendMessage',{
                        sender:userId,
                        receiver:{
                            receiver_type:'room',
                            receiver_id:roomId
                        },
                        msg:`hello 3!`
                    });
                }

                socket.on('sendInitChatLog',(data)=>{
                    chatLogs=data;

                    $('#chatRoom').empty();
                    $('#chatBoard').empty();
                    for(chatLog of chatLogs){
                        let option=$(`<option>${chatLog.chatRoomId}</option>`)
                        $('#chatRoom').append(option);

                    }
                    
                    let selectedRoom=chatLogs.find(chatLog=>chatLog.chatRoomId==$("#chatRoom").val());

                    for(chat of selectedRoom.chats){
                        $("#ChatBoard").append(`<p>${chat.sender.sender_id}: ${chat.msg}</p>`);
                    }
                    $("#ChatBoard").scrollTop($("#ChatBoard")[0].scrollHeight);
                })
                socket.on('sendMessage',(data)=>{
                    console.log(data);
                })

                $("#chatRoom").on("change",function(){
                    $('#chatBoard').empty();
                    let selectedRoom=chatLogs.find(chatLog=>chatLog.chatRoomId==$("#chatRoom").val());
                    
                    for(chat of selectedRoom.chats){
                        $("#ChatBoard").append(`<p>${chat.sender.sender_id}: ${chat.msg}</p>`);
                    }
                    $("#ChatBoard").scrollTop($("#ChatBoard")[0].scrollHeight);
                })

            }
        </script>
        <style>
            #ChatBoard{
                width:500px;
                height:500px;
                border:2px solid gray;
            }
        </style>
    </head>
<body>
    <h2 id="Hchat">채팅방이름</h2>

    <form id="form">
        <!-- <input type="text" id="chatRoom" placeholder="채팅방명 입력"/> -->
        <select id="chatRoom">
            <option></option>
        </select>

        <input type="text" id="chatNickName" placeholder="이름 입력"/>
        <input type="text" id="chatMessage" placeholder="메세지 입력"/>
        <input type="button" id="chatSend" value="Send"/>
    </form>

    <br/>
    <div id="ChatBoard" style="overflow:scroll;"></div>
</body>
</html>